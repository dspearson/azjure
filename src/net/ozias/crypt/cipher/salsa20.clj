;; ## Salsa20
;; Designed to meet the [Salsa20 Spec](http://cr.yp.to/snuffle/spec.pdf) spec
(ns net.ozias.crypt.cipher.salsa20
  (:require [net.ozias.crypt.cipher.streamcipher :refer [StreamCipher]]
            [net.ozias.crypt.libcrypt :refer (+modw to-hex)]
            [net.ozias.crypt.libbyte :refer (<<< bytes-word word-bytes)]))

(def t1 
  [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
   0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
   0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
   0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0])

(def t2
  [0xD3 0x9F 0x0D 0x73 0x4C 0x37 0x52 0xB7
   0x03 0x75 0xDE 0x25 0xBF 0xBB 0xEA 0x88
   0x31 0xED 0xB3 0x30 0x01 0x6A 0xB2 0xDB
   0xAF 0xC7 0xA6 0x30 0x56 0x10 0xB3 0xCF
   0x1F 0xF0 0x20 0x3F 0x0F 0x53 0x5D 0xA1
   0x74 0x93 0x30 0x71 0xEE 0x37 0xCC 0x24
   0x4F 0xC9 0xEB 0x4F 0x03 0x51 0x9C 0x2F
   0xCB 0x1A 0xF4 0xF3 0x58 0x76 0x68 0x36])

(def t3
  [0x58 0x76 0x68 0x36 0x4F 0xC9 0xEB 0x4F
   0x03 0x51 0x9C 0x2F 0xCB 0x1A 0xF4 0xF3
   0xBF 0xBB 0xEA 0x88 0xD3 0x9F 0x0D 0x73
   0x4C 0x37 0x52 0xB7 0x03 0x75 0xDE 0x25
   0x56 0x10 0xB3 0xCF 0x31 0xED 0xB3 0x30
   0x01 0x6A 0xB2 0xDB 0xAF 0xC7 0xA6 0x30
   0xEE 0x37 0xCC 0x24 0x1F 0xF0 0x20 0x3F
   0x0F 0x53 0x5D 0xA1 0x74 0x93 0x30 0x71])

(def t4
  [0x06 0x7C 0x53 0x92 0x26 0xBF 0x09 0x32
   0x04 0xA1 0x2F 0xDE 0x7A 0xB6 0xDF 0xB9
   0x4B 0x1B 0x00 0xD8 0x10 0x7A 0x07 0x59
   0xA2 0x68 0x65 0x93 0xD5 0x15 0x36 0x5F
   0xE1 0xFD 0x8B 0xB0 0x69 0x84 0x17 0x74
   0x4C 0x29 0xB0 0xCF 0xDD 0x22 0x9D 0x6C
   0x5E 0x5E 0x63 0x34 0x5A 0x75 0x5B 0xDC
   0x92 0xBE 0xEF 0x8F 0xC4 0xB0 0x82 0xBA])

(def out2
  [0x6D 0x2A 0xB2 0xA8 0x9C 0xF0 0xF8 0xEE
   0xA8 0xC4 0xBE 0xCB 0x1A 0x6E 0xAA 0x9A
   0x1D 0x1D 0x96 0x1A 0x96 0x1E 0xEB 0xF9
   0xBE 0xA3 0xFB 0x30 0x45 0x90 0x33 0x39
   0x76 0x28 0x98 0x9D 0xB4 0x39 0x1B 0x5E
   0x6B 0x2A 0xEC 0x23 0x1B 0x6F 0x72 0x72
   0xDB 0xEC 0xE8 0x87 0x6F 0x9B 0x6E 0x12
   0x18 0xE8 0x5F 0x9E 0xB3 0x13 0x30 0xCA])

(def out3
  [0xB3 0x13 0x30 0xCA 0xDB 0xEC 0xE8 0x87
   0x6F 0x9B 0x6E 0x12 0x18 0xE8 0x5F 0x9E
   0x1A 0x6E 0xAA 0x9A 0x6D 0x2A 0xB2 0xA8
   0x9C 0xF0 0xF8 0xEE 0xA8 0xC4 0xBE 0xCB
   0x45 0x90 0x33 0x39 0x1D 0x1D 0x96 0x1A
   0x96 0x1E 0xEB 0xF9 0xBE 0xA3 0xFB 0x30
   0x1B 0x6F 0x72 0x72 0x76 0x28 0x98 0x9D
   0xB4 0x39 0x1B 0x5E 0x6B 0x2A 0xEC 0x23])

(def out4
  [0x08 0x12 0x26 0xC7 0x77 0x4C 0xD7 0x43
   0xAD 0x7F 0x90 0xA2 0x67 0xD4 0xB0 0xD9
   0xC0 0x13 0xE9 0x21 0x9F 0xC5 0x9A 0xA0
   0x80 0xF3 0xDB 0x41 0xAB 0x88 0x87 0xE1
   0x7B 0x0B 0x44 0x56 0xED 0x52 0x14 0x9B
   0x85 0xBD 0x09 0x53 0xA7 0x74 0xC2 0x4E
   0x7A 0x7F 0xC3 0xB9 0xB9 0xCC 0xBC 0x5A
   0xF5 0x09 0xB7 0xF8 0xE2 0x55 0xF5 0x68])

(defn- quarterround [[y0 y1 y2 y3]]
  (let [z1 (bit-xor y1 (<<< (+modw y0 y3) 7))
        z2 (bit-xor y2 (<<< (+modw z1 y0) 9))
        z3 (bit-xor y3 (<<< (+modw z2 z1) 13))
        z0 (bit-xor y0 (<<< (+modw z3 z2) 18))]
    [z0 z1 z2 z3]))

(defn- rowround [[y0 y1 y2 y3 y4 y5 y6 y7 y8 y9 y10 y11 y12 y13 y14 y15]]
  (let [[z0 z1 z2 z3] (quarterround [y0 y1 y2 y3])
        [z5 z6 z7 z4] (quarterround [y5 y6 y7 y4])
        [z10 z11 z8 z9] (quarterround [y10 y11 y8 y9])
        [z15 z12 z13 z14] (quarterround [y15 y12 y13 y14])]
    [z0 z1 z2 z3 z4 z5 z6 z7 z8 z9 z10 z11 z12 z13 z14 z15]))
  
(defn- columnround [[x0 x1 x2 x3 x4 x5 x6 x7 x8 x9 x10 x11 x12 x13 x14 x15]]
  (let [[y0 y4 y8 y12] (quarterround [x0 x4 x8 x12])
        [y5 y9 y13 y1] (quarterround [x5 x9 x13 x1])
        [y10 y14 y2 y6] (quarterround [x10 x14 x2 x6])
        [y15 y3 y7 y11] (quarterround [x15 x3 x7 x11])]
    [y0 y1 y2 y3 y4 y5 y6 y7 y8 y9 y10 y11 y12 y13 y14 y15]))

(defn- doubleround [x _]
  (rowround (columnround x)))

(defn- salsa20 [in]
  (let [x (mapv #(bytes-word % true) (partition 4 in))]
    (->> (range 10)
         (reduce doubleround x)
         (mapv +modw x)
         (mapv #(word-bytes % true))
         (reduce into))))

;; ### Salsa20
;; Extend the StreamCipher protocol thorough the Salsa20 record type
(defrecord Salsa20 []
  StreamCipher
  (process-byte [_ byte]
    byte)
  (process-bytes [_ bytes]
    (salsa20 bytes)))
