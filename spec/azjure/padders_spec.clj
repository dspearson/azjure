(ns azjure.padders-spec
  (:require [azjure.cipher.aes :refer :all]
            [azjure.libtest :refer :all]
            [azjure.padders :refer :all]
            [speclj.core :refer :all]))

(def ^{:private true
       :doc     "Configuration Map"}
  cm {:type :aes})

(def base-tests
  [["should pad 15 bytes"
    "should unpad to 1 byte"
    (rangev 1)]
   ["should pad 14 bytes"
    "should unpad to 2 bytes"
    (rangev 2)]
   ["should pad 13 bytes"
    "should unpad to 3 bytes"
    (rangev 3)]
   ["should pad 1 byte"
    "should unpad to 15 bytes"
    (rangev 15)]
   ["should pad 15 bytes in 2nd block"
    "should unpad to 17 bytes"
    (rangev 17)]
   ["should pad 0 bytes"
    "should unpad to 16 bytes"
    (rangev 16)]])

(def ^{:private true
       :doc     "ISO/IEC 7816-4 Test Blocks"}
  iso7816-tests
  (map conj base-tests [[0x00 0x80 0x00 0x00 0x00 0x00 0x00 0x00
                         0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
                        [0x00 0x01 0x80 0x00 0x00 0x00 0x00 0x00
                         0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
                        [0x00 0x01 0x02 0x80 0x00 0x00 0x00 0x00
                         0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
                        [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                         0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x80]
                        [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                         0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
                         0x10 0x80 0x00 0x00 0x00 0x00 0x00 0x00
                         0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
                        [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                         0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F]]))

(def ^{:private true
       :doc     "ISO 10126 Test Blocks"}
  iso10126-tests
  (conj (->> (map conj base-tests
                  [[[0x00] [0x0F]]
                   [[0x00 0x01] [0x0E]]
                   [[0x00 0x01 0x02] [0x0D]]
                   [[0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                     0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E] [0x01]]
                   [[0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                     0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
                     0x10] [0x0F]]
                   []])
             (butlast)
             (vec))
        ["should pad 0 bytes"
         "should unpad to 16 bytes - last byte value must be > blocksize value"
         [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
          0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x10]
         [[0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
           0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x10] []]]))

(def ^{:private true
       :doc     "PKCS7 Test Blocks"}
  pkcs7-tests
  (map conj base-tests [[0x00 0x0F 0x0F 0x0F 0x0F 0x0F 0x0F 0x0F
                         0x0F 0x0F 0x0F 0x0F 0x0F 0x0F 0x0F 0x0F]
                        [0x00 0x01 0x0E 0x0E 0x0E 0x0E 0x0E 0x0E
                         0x0E 0x0E 0x0E 0x0E 0x0E 0x0E 0x0E 0x0E]
                        [0x00 0x01 0x02 0x0D 0x0D 0x0D 0x0D 0x0D
                         0x0D 0x0D 0x0D 0x0D 0x0D 0x0D 0x0D 0x0D]
                        [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                         0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x01]
                        [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                         0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
                         0x10 0x0F 0x0F 0x0F 0x0F 0x0F 0x0F 0x0F
                         0x0F 0x0F 0x0F 0x0F 0x0F 0x0F 0x0F 0x0F]
                        [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                         0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F]]))

(def ^{:private true
       :doc     "ANSI X.923 Test Blocks"}
  x923-tests
  (map conj base-tests [[0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
                         0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x0F]
                        [0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00
                         0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x0E]
                        [0x00 0x01 0x02 0x00 0x00 0x00 0x00 0x00
                         0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x0D]
                        [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                         0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x01]
                        [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                         0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
                         0x10 0x00 0x00 0x00 0x00 0x00 0x00 0x00
                         0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x0F]
                        [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                         0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F]]))

(def ^{:private true
       :doc     "zero Test Blocks"}
  zero-tests
  (conj
    (rest (map conj base-tests [[0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00
                                 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
                                [0x00 0x01 0x00 0x00 0x00 0x00 0x00 0x00
                                 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
                                [0x00 0x01 0x02 0x00 0x00 0x00 0x00 0x00
                                 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
                                [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                                 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x00]
                                [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                                 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F
                                 0x10 0x00 0x00 0x00 0x00 0x00 0x00 0x00
                                 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]
                                [0x00 0x01 0x02 0x03 0x04 0x05 0x06 0x07
                                 0x08 0x09 0x0A 0x0B 0x0C 0x0D 0x0E 0x0F]]))
    ["should pad 15 bytes - all zeros in unreversible"
     "should unpad to 1 byte"
     [0x01]
     [0x01 0x00 0x00 0x00 0x00 0x00 0x00 0x00
      0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00]]))

(describe
  "padders"
  (context "ISO/IEC 7816-4"
           (check-padder (assoc cm :pad :iso7816) iso7816-tests))
  (context "ISO 10126"
           (check-padder (assoc cm :pad :iso10126) iso10126-tests))
  (context "PKCS7"
           (check-padder (assoc cm :pad :pkcs7) pkcs7-tests))
  (context "ANSI X.923"
           (check-padder (assoc cm :pad :x923) x923-tests))
  (context "zero"
           (check-padder (assoc cm :pad :zero) zero-tests)))